# MAKEFILE for mac
# Healpix compiled by modifying config.osx file by hand
# with g++-7 -m64

# EXTERNAL LIB
GSL = /usr/local/Cellar/gsl/2.3
FFTW = /usr/local/Cellar/fftw/3.3.6-pl2
CFITSIO = /usr/local/Cellar/cfitsio/3.390
HEALPIX = /Users/jiaxin/lab/Healpix_3.31/src/cxx/osx

# INTERNAL DIR
BASE = /Users/jiaxin/lab/hamx

# COMPILER
CXX = g++-7 -std=c++11

# DEBUG FLAGS
DEBUG = #-NDEBUG

# COMPILE OPTIONS
CXXFLAGS = -O2 -fopenmp -Wall -fPIC -Wno-deprecated -pthread $(DEBUG)

# RULE
$(BASE)/src/%.o : %.cc
	$(CXX) $(CXXFLAGS)  -o $@ $<


# HAMMURABI STAND ALONE
hammurabi: EXT_INC = -I$(CFITSIO)/include -I$(GSL)/include -I$(FFTW)/include \
	-I$(HEALPIX)/include \
	-I$(BASE)/include -I.
hammurabi: CXXFLAGS += $(EXT_INC)
 
hammurabi: ALL_L = -L$(CFITSIO)/lib -L$(GSL)/lib -L$(FFTW)/lib \
	-L$(HEALPIX)/lib \
	-L$(BASE)/lib -L. 
hammurabi: LFLAGS = $(ALL_L) \
	-lhammurabi \
	-lhealpix_cxx -lcxxsupport -lc_utils -lfftpack -lcfitsio \
	-lgsl -lgslcblas -lm -lfftw3 -fopenmp

hammurabi_OBJ = $(addprefix $(BASE)/src/, tinyxml2.o class_grid.o class_pond.o namespace_toolkit.o class_fe.o class_fernd.o class_breg.o class_brnd.o class_cre.o class_int.o hammurabi.o) 

$(hammurabi_OBJ): $(addprefix $(BASE)/include/, cgs_units_file.h class*.h namespace_toolkit.h tinyxml2.h)

$(BASE)/lib/libhammurabi.a: $(hammurabi_OBJ)
	ar cr $(BASE)/lib/libhammurabi.a $(hammurabi_OBJ)

hammurabi: $(hammurabi_OBJ) $(BASE)/lib/libhammurabi.a run $(BASE)/src/hammurabi.o
	$(CXX) -o $(BASE)/run/hammurabi $(BASE)/src/hammurabi.o $(LFLAGS)

# DRAGON STAND ALONE

# HAMMURABI-DRAGON

# ALIAS
.PHONY: clean
clean:
	rm $(BASE)/lib/*.a $(BASE)/src/*.o; rm -rf $(BASE)/run
.PHONY: tar 
tar:
	tar cfv NUWA.tar.gz makefile* include data src wrapper fit
.PHONY: run
run:
	rm -rf $(BASE)/run ; mkdir $(BASE)/run; cp $(BASE)/data/* $(BASE)/run; cp $(BASE)/python_utils/* $(BASE)/run
# END
